<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="
          http://www.liquibase.org/xml/ns/dbchangelog
          https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.24.xsd">

    <!-- PATIENT BADGE STATISTICS - Aggregated data for efficient badge evaluation -->
    <changeSet id="0011-01-patient-badge-statistics" author="MediBook_Admin">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="patient_badge_statistics"/>
            </not>
        </preConditions>

        <createTable tableName="patient_badge_statistics">
            <column name="patient_id" type="uuid">
                <constraints primaryKey="true" nullable="false"/>
            </column>

            <!-- Turn-related statistics -->
            <column name="total_turns_completed" type="int" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="total_turns_cancelled" type="int" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="total_turns_no_show" type="int" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="turns_last_12_months" type="int" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="turns_last_6_months" type="int" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="turns_last_90_days" type="int" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>

            <!-- Attendance and punctuality statistics -->
            <column name="last_5_turns_attendance_rate" type="numeric(5,2)" defaultValueNumeric="0.0">
                <constraints nullable="false"/>
            </column>
            <column name="last_10_turns_punctual_count" type="int" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="last_5_turns_advance_booking_count" type="int" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="last_15_turns_collaboration_count" type="int" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="last_15_turns_follow_instructions_count" type="int" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>

            <!-- File upload statistics -->
            <column name="last_10_turns_files_uploaded_count" type="int" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>

            <!-- Rating statistics -->
            <column name="total_ratings_given" type="int" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="total_ratings_received" type="int" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="avg_rating_given" type="numeric(3,2)" defaultValueNumeric="0.0">
                <constraints nullable="false"/>
            </column>
            <column name="avg_rating_received" type="numeric(3,2)" defaultValueNumeric="0.0">
                <constraints nullable="false"/>
            </column>

            <!-- Doctor relationship statistics -->
            <column name="total_unique_doctors" type="int" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="turns_with_same_doctor_last_12_months" type="int" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="different_specialties_last_12_months" type="int" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>

            <!-- Last update timestamp -->
            <column name="last_updated_at" type="timestamptz" defaultValueComputed="now()">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Foreign key to users table -->
        <addForeignKeyConstraint
            baseTableName="patient_badge_statistics"
            baseColumnNames="patient_id"
            constraintName="fk_patient_badge_stats_patient"
            referencedTableName="users"
            referencedColumnNames="id"
            onDelete="CASCADE"/>

        <!-- Index for efficient updates -->
        <createIndex indexName="idx_patient_badge_stats_updated" tableName="patient_badge_statistics">
            <column name="last_updated_at"/>
        </createIndex>
    </changeSet>

    <!-- PATIENT BADGES TABLE -->
    <changeSet id="0011-02-patient-badges" author="MediBook_Admin">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="patient_badges"/>
            </not>
        </preConditions>

        <createTable tableName="patient_badges">
            <column name="id" type="uuid" defaultValueComputed="uuid_generate_v4()">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="patient_id" type="uuid">
                <constraints nullable="false"/>
            </column>
            <column name="badge_type" type="text">
                <constraints nullable="false"/>
            </column>
            <column name="earned_at" type="timestamptz" defaultValueComputed="now()">
                <constraints nullable="false"/>
            </column>
            <column name="is_active" type="boolean" defaultValueBoolean="true">
                <constraints nullable="false"/>
            </column>
            <column name="last_evaluated_at" type="timestamptz" defaultValueComputed="now()">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Foreign key to users table -->
        <addForeignKeyConstraint
            baseTableName="patient_badges"
            baseColumnNames="patient_id"
            constraintName="fk_patient_badges_patient"
            referencedTableName="users"
            referencedColumnNames="id"
            onDelete="CASCADE"/>

        <!-- Unique constraint: One patient can have each badge type only once -->
        <addUniqueConstraint
            tableName="patient_badges"
            columnNames="patient_id,badge_type"
            constraintName="uc_patient_badge_type"/>

        <!-- Indexes for better query performance -->
        <createIndex indexName="idx_patient_badges_patient_id" tableName="patient_badges">
            <column name="patient_id"/>
        </createIndex>

        <createIndex indexName="idx_patient_badges_badge_type" tableName="patient_badges">
            <column name="badge_type"/>
        </createIndex>

        <createIndex indexName="idx_patient_badges_is_active" tableName="patient_badges">
            <column name="is_active"/>
        </createIndex>
    </changeSet>

    <!-- Initialize statistics for existing patients -->
    <changeSet id="0011-03-initialize-patient-statistics" author="MediBook_Admin">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="patient_badge_statistics"/>
            <tableExists tableName="users"/>
        </preConditions>

        <sql>
            -- Create statistics entry for all existing patients
            INSERT INTO patient_badge_statistics (patient_id, last_updated_at)
            SELECT id, now()
            FROM users
            WHERE role = 'PATIENT'
            ON CONFLICT (patient_id) DO NOTHING;
        </sql>
    </changeSet>

    <!-- Performance optimization indexes for patient badge evaluation queries -->
    <changeSet id="0011-04-add-patient-performance-indexes" author="MediBook_Optimization">
        <comment>
            Critical indexes for patient badge evaluation performance.
            These composite indexes optimize the most frequent queries used in patient badge evaluation.
        </comment>

        <!-- Turns table indexes for patient queries -->
        <createIndex indexName="idx_turns_patient_status_scheduled" tableName="turns_assigned">
            <column name="patient_id"/>
            <column name="status"/>
            <column name="scheduled_at" descending="true"/>
        </createIndex>

        <createIndex indexName="idx_turns_patient_scheduled_desc" tableName="turns_assigned">
            <column name="patient_id"/>
            <column name="scheduled_at" descending="true"/>
        </createIndex>

        <createIndex indexName="idx_turns_patient_doctor" tableName="turns_assigned">
            <column name="patient_id"/>
            <column name="doctor_id"/>
        </createIndex>

        <!-- File uploads indexes for patient file tracking -->
        <createIndex indexName="idx_file_uploads_patient_created" tableName="file_uploads">
            <column name="patient_id"/>
            <column name="created_at" descending="true"/>
        </createIndex>

        <createIndex indexName="idx_file_uploads_turn" tableName="file_uploads">
            <column name="turn_id"/>
        </createIndex>
    </changeSet>

    <!-- Add patient badge progress tracking columns -->
    <changeSet id="0011-05-add-patient-badge-progress-columns" author="MediBook_BadgeProgress">
        <comment>
            Add pre-calculated progress columns (0-100) for each patient badge type.
            Progress is calculated and cached when statistics are updated to avoid
            expensive real-time calculations on each page load.
        </comment>

        <!-- Health Commitment badge progress -->
        <addColumn tableName="patient_badge_statistics">
            <column name="progress_preventive_patient" type="DOUBLE PRECISION" defaultValueNumeric="0.0">
                <constraints nullable="false"/>
            </column>
        </addColumn>

        <addColumn tableName="patient_badge_statistics">
            <column name="progress_total_commitment" type="DOUBLE PRECISION" defaultValueNumeric="0.0">
                <constraints nullable="false"/>
            </column>
        </addColumn>

        <addColumn tableName="patient_badge_statistics">
            <column name="progress_therapeutic_continuity" type="DOUBLE PRECISION" defaultValueNumeric="0.0">
                <constraints nullable="false"/>
            </column>
        </addColumn>

        <addColumn tableName="patient_badge_statistics">
            <column name="progress_constant_user" type="DOUBLE PRECISION" defaultValueNumeric="0.0">
                <constraints nullable="false"/>
            </column>
        </addColumn>

        <!-- Responsibility badge progress -->
        <addColumn tableName="patient_badge_statistics">
            <column name="progress_always_punctual" type="DOUBLE PRECISION" defaultValueNumeric="0.0">
                <constraints nullable="false"/>
            </column>
        </addColumn>

        <addColumn tableName="patient_badge_statistics">
            <column name="progress_expert_planner" type="DOUBLE PRECISION" defaultValueNumeric="0.0">
                <constraints nullable="false"/>
            </column>
        </addColumn>

        <addColumn tableName="patient_badge_statistics">
            <column name="progress_model_collaborator" type="DOUBLE PRECISION" defaultValueNumeric="0.0">
                <constraints nullable="false"/>
            </column>
        </addColumn>

        <!-- Preparation badge progress -->
        <addColumn tableName="patient_badge_statistics">
            <column name="progress_prepared_patient" type="DOUBLE PRECISION" defaultValueNumeric="0.0">
                <constraints nullable="false"/>
            </column>
        </addColumn>

        <addColumn tableName="patient_badge_statistics">
            <column name="progress_constructive_evaluator" type="DOUBLE PRECISION" defaultValueNumeric="0.0">
                <constraints nullable="false"/>
            </column>
        </addColumn>

        <addColumn tableName="patient_badge_statistics">
            <column name="progress_exemplary_patient" type="DOUBLE PRECISION" defaultValueNumeric="0.0">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

</databaseChangeLog>