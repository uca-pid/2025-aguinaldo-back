<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="
          http://www.liquibase.org/xml/ns/dbchangelog
          https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.24.xsd">

    <!-- DOCTOR BADGE STATISTICS - Aggregated data for efficient badge evaluation -->
    <changeSet id="0010-01-doctor-badge-statistics" author="MediBook_Admin">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="doctor_badge_statistics"/>
            </not>
        </preConditions>
        
        <createTable tableName="doctor_badge_statistics">
            <column name="doctor_id" type="uuid">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            
            <!-- Rating-related statistics -->
            <column name="total_ratings_received" type="int" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="last_50_communication_count" type="int" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="last_50_empathy_count" type="int" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="last_50_punctuality_count" type="int" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="last_100_avg_rating" type="numeric(3,2)"/>
            <column name="last_100_low_rating_count" type="int" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            
            <!-- Turn-related statistics -->
            <column name="total_turns_completed" type="int" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="total_turns_cancelled" type="int" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="total_turns_no_show" type="int" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="turns_last_90_days" type="int" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="cancellations_last_90_days" type="int" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="no_shows_last_90_days" type="int" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            
            <!-- Documentation statistics -->
            <column name="last_50_documented_count" type="int" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="last_30_documented_count" type="int" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="last_30_total_words" type="int" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="last_30_avg_words_per_entry" type="numeric(8,2)" defaultValueNumeric="0.0">
                <constraints nullable="false"/>
            </column>
            
            <!-- Relationship statistics -->
            <column name="total_unique_patients" type="int" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="returning_patients_count" type="int" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            
            <!-- Response statistics -->
            <column name="last_10_requests_handled" type="int" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            
            <!-- Specialty ranking cache -->
            <column name="specialty_rank_percentile" type="numeric(5,2)"/>
            
            <!-- Last update timestamp -->
            <column name="last_updated_at" type="timestamptz" defaultValueComputed="now()">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Foreign key to users table -->
        <addForeignKeyConstraint 
            baseTableName="doctor_badge_statistics" 
            baseColumnNames="doctor_id"
            constraintName="fk_doctor_badge_stats_doctor"
            referencedTableName="users" 
            referencedColumnNames="id"
            onDelete="CASCADE"/>

        <!-- Index for efficient updates -->
        <createIndex indexName="idx_doctor_badge_stats_updated" tableName="doctor_badge_statistics">
            <column name="last_updated_at"/>
        </createIndex>
    </changeSet>

    <!-- DOCTOR BADGES TABLE -->
    <changeSet id="0010-02-doctor-badges" author="MediBook_Admin">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="doctor_badges"/>
            </not>
        </preConditions>
        
        <createTable tableName="doctor_badges">
            <column name="id" type="uuid" defaultValueComputed="uuid_generate_v4()">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="doctor_id" type="uuid">
                <constraints nullable="false"/>
            </column>
            <column name="badge_type" type="text">
                <constraints nullable="false"/>
            </column>
            <column name="earned_at" type="timestamptz" defaultValueComputed="now()">
                <constraints nullable="false"/>
            </column>
            <column name="is_active" type="boolean" defaultValueBoolean="true">
                <constraints nullable="false"/>
            </column>
            <column name="last_evaluated_at" type="timestamptz" defaultValueComputed="now()">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Foreign key to users table -->
        <addForeignKeyConstraint 
            baseTableName="doctor_badges" 
            baseColumnNames="doctor_id"
            constraintName="fk_doctor_badges_doctor"
            referencedTableName="users" 
            referencedColumnNames="id"
            onDelete="CASCADE"/>

        <!-- Unique constraint: One doctor can have each badge type only once -->
        <addUniqueConstraint 
            tableName="doctor_badges" 
            columnNames="doctor_id,badge_type" 
            constraintName="uc_doctor_badge_type"/>

        <!-- Indexes for better query performance -->
        <createIndex indexName="idx_doctor_badges_doctor_id" tableName="doctor_badges">
            <column name="doctor_id"/>
        </createIndex>

        <createIndex indexName="idx_doctor_badges_badge_type" tableName="doctor_badges">
            <column name="badge_type"/>
        </createIndex>

        <createIndex indexName="idx_doctor_badges_is_active" tableName="doctor_badges">
            <column name="is_active"/>
        </createIndex>
    </changeSet>

    <!-- Initialize statistics for existing doctors -->
    <changeSet id="0010-03-initialize-doctor-statistics" author="MediBook_Admin">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="doctor_badge_statistics"/>
            <tableExists tableName="users"/>
        </preConditions>
        
        <sql>
            -- Create statistics entry for all existing doctors
            INSERT INTO doctor_badge_statistics (doctor_id, last_updated_at)
            SELECT id, now()
            FROM users
            WHERE role = 'DOCTOR'
            ON CONFLICT (doctor_id) DO NOTHING;
        </sql>
    </changeSet>

    <!-- Performance optimization indexes for badge evaluation queries -->
    <changeSet id="0010-04-add-performance-indexes" author="MediBook_Optimization">
        <comment>
            Critical indexes for badge evaluation performance.
            These composite indexes optimize the most frequent queries used in badge evaluation.
        </comment>
        
        <!-- Ratings table indexes for efficient last N ratings queries -->
        <createIndex indexName="idx_ratings_rated_created_desc" tableName="ratings">
            <column name="rated_id"/>
            <column name="created_at" descending="true"/>
        </createIndex>
        
        <createIndex indexName="idx_ratings_rated_score" tableName="ratings">
            <column name="rated_id"/>
            <column name="score"/>
        </createIndex>
        
        <createIndex indexName="idx_ratings_turn_rater" tableName="ratings">
            <column name="turn_id"/>
            <column name="rater_id"/>
        </createIndex>
        
        <!-- Turns table indexes for doctor queries -->
        <createIndex indexName="idx_turns_doctor_status_scheduled" tableName="turns_assigned">
            <column name="doctor_id"/>
            <column name="status"/>
            <column name="scheduled_at" descending="true"/>
        </createIndex>
        
        <createIndex indexName="idx_turns_doctor_scheduled_desc" tableName="turns_assigned">
            <column name="doctor_id"/>
            <column name="scheduled_at" descending="true"/>
        </createIndex>
        
        <createIndex indexName="idx_turns_doctor_patient" tableName="turns_assigned">
            <column name="doctor_id"/>
            <column name="patient_id"/>
        </createIndex>
        
        <!-- Medical history indexes for documentation rate queries -->
        <createIndex indexName="idx_medical_history_doctor_created" tableName="medical_history">
            <column name="doctor_id"/>
            <column name="created_at" descending="true"/>
        </createIndex>
        
        <createIndex indexName="idx_medical_history_turn" tableName="medical_history">
            <column name="turn_id"/>
        </createIndex>
        
        <!-- User indexes for specialty ranking queries -->
        <createIndex indexName="idx_users_role_status" tableName="users">
            <column name="role"/>
            <column name="status"/>
        </createIndex>
    </changeSet>

    <!-- Add badge progress tracking columns -->
    <changeSet id="0010-05-add-badge-progress-columns" author="MediBook_BadgeProgress">
        <comment>
            Add pre-calculated progress columns (0-100) for each badge type.
            Progress is calculated and cached when statistics are updated to avoid
            expensive real-time calculations on each page load.
        </comment>
        
        <!-- Quality of Care badge progress -->
        <addColumn tableName="doctor_badge_statistics">
            <column name="progress_excellence_in_care" type="DOUBLE PRECISION" defaultValueNumeric="0.0">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        
        <addColumn tableName="doctor_badge_statistics">
            <column name="progress_empathy_champion" type="DOUBLE PRECISION" defaultValueNumeric="0.0">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        
        <addColumn tableName="doctor_badge_statistics">
            <column name="progress_clear_communicator" type="DOUBLE PRECISION" defaultValueNumeric="0.0">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        
        <addColumn tableName="doctor_badge_statistics">
            <column name="progress_detailed_diagnostician" type="DOUBLE PRECISION" defaultValueNumeric="0.0">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        
        <!-- Professionalism badge progress -->
        <addColumn tableName="doctor_badge_statistics">
            <column name="progress_timely_professional" type="DOUBLE PRECISION" defaultValueNumeric="0.0">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        
        <addColumn tableName="doctor_badge_statistics">
            <column name="progress_reliable_expert" type="DOUBLE PRECISION" defaultValueNumeric="0.0">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        
        <addColumn tableName="doctor_badge_statistics">
            <column name="progress_flexible_caregiver" type="DOUBLE PRECISION" defaultValueNumeric="0.0">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        
        <addColumn tableName="doctor_badge_statistics">
            <column name="progress_agile_responder" type="DOUBLE PRECISION" defaultValueNumeric="0.0">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        
        <!-- Consistency badge progress -->
        <addColumn tableName="doctor_badge_statistics">
            <column name="progress_relationship_builder" type="DOUBLE PRECISION" defaultValueNumeric="0.0">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        
        <addColumn tableName="doctor_badge_statistics">
            <column name="progress_top_specialist" type="DOUBLE PRECISION" defaultValueNumeric="0.0">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        
        <addColumn tableName="doctor_badge_statistics">
            <column name="progress_medical_legend" type="DOUBLE PRECISION" defaultValueNumeric="0.0">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        
        <addColumn tableName="doctor_badge_statistics">
            <column name="progress_all_star_doctor" type="DOUBLE PRECISION" defaultValueNumeric="0.0">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

</databaseChangeLog>
