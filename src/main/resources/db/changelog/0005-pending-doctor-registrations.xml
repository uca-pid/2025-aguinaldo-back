<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="
          http://www.liquibase.org/xml/ns/dbchangelog
          https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.24.xsd">

    <changeSet id="0005-1" author="system">
        <comment>Add created_at column to users table</comment>
        
        <addColumn tableName="users">
            <column name="created_at" type="timestamp with time zone" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="0005-2" author="system">
        <comment>Add pending doctor registration fields to doctor_profiles table</comment>
        
        <addColumn tableName="doctor_profiles">
            <column name="reviewed_at" type="timestamp with time zone"/>
            <column name="reviewed_by" type="uuid"/>
            <column name="rejection_reason" type="text"/>
        </addColumn>
    </changeSet>

    <changeSet id="0005-3" author="system">
        <comment>Add foreign key constraint for reviewed_by</comment>
        
        <addForeignKeyConstraint 
            baseTableName="doctor_profiles"
            baseColumnNames="reviewed_by"
            constraintName="fk_doctor_profiles_reviewed_by"
            referencedTableName="users"
            referencedColumnNames="id"
            onDelete="SET NULL"/>
    </changeSet>

    <changeSet id="0005-4" author="system">
        <comment>Add indexes for doctor profile review fields</comment>
        
        <createIndex tableName="users" indexName="idx_users_status_role">
            <column name="status"/>
            <column name="role"/>
        </createIndex>
        
        <createIndex tableName="users" indexName="idx_users_created_at">
            <column name="created_at"/>
        </createIndex>
        
        <createIndex tableName="doctor_profiles" indexName="idx_doctor_profiles_reviewed_by">
            <column name="reviewed_by"/>
        </createIndex>
        
        <createIndex tableName="doctor_profiles" indexName="idx_doctor_profiles_reviewed_at">
            <column name="reviewed_at"/>
        </createIndex>
    </changeSet>

</databaseChangeLog>